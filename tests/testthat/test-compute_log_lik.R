test_that("correct sum", {
  dat <- generate_basic_example()
  beta <- matrix(1:4, nrow = 2)
  res <- compute_log_lik(0.8, 0.1, beta, dat$x, dat$y, dat$KO_mod_mat)
  y <- dat$y
  x <- dat$x
  # compute product by hand
  sum_res <- -(log(0.1^y[1, 1] * 0.9^(1 - y[1, 1]) * 0.1^y[1, 2] * 0.9^(1 - y[1, 2]) *
        0.1^y[1, 3] * 0.9^(1 - y[1, 3]) * 0.1^y[1, 4] * 0.9^(1 - y[1, 4]) *
        0.1^y[1, 5] * 0.9^(1 - y[1, 5]) *
        (1 - expit(x[1, ] %*% beta[, 1])) * (1 - expit(x[1, ] %*% beta[, 2])) +
        0.8^y[1, 1] * 0.2^(1 - y[1, 1]) * 0.1^y[1, 2] * 0.9^(1 - y[1, 2]) *
        0.1^y[1, 3] * 0.9^(1 - y[1, 3]) * 0.8^y[1, 4] * 0.2^(1 - y[1, 4]) *
        0.8^y[1, 5] * 0.2^(1 - y[1, 5]) *
        (1 - expit(x[1, ] %*% beta[, 1])) * (expit(x[2, ] %*% beta[, 2])) +
        0.8^y[1, 1] * 0.2^(1 - y[1, 1]) * 0.8^y[1, 2] * 0.2^(1 - y[1, 2]) *
        0.8^y[1, 3] * 0.2^(1 - y[1, 3]) * 0.1^y[1, 4] * 0.9^(1 - y[1, 4]) *
        0.1^y[1, 5] * 0.9^(1 - y[1, 5]) *
        (expit(x[1, ] %*% beta[, 1])) * (1 - expit(x[1, ] %*% beta[, 2])) +
        0.8^y[1, 1] * 0.2^(1 - y[1, 1]) * 0.8^y[1, 2] * 0.2^(1 - y[1, 2]) *
        0.8^y[1, 3] * 0.2^(1 - y[1, 3]) * 0.8^y[1, 4] * 0.2^(1 - y[1, 4]) *
        0.8^y[1, 5] * 0.2^(1 - y[1, 5]) *
        (expit(x[1, ] %*% beta[, 1])) * (expit(x[1, ] %*% beta[, 2]))) +
    log(0.1^y[2, 1] * 0.9^(1 - y[2, 1]) * 0.1^y[2, 2] * 0.9^(1 - y[2, 2]) *
        0.1^y[2, 3] * 0.9^(1 - y[2, 3]) * 0.1^y[2, 4] * 0.9^(1 - y[2, 4]) *
        0.1^y[2, 5] * 0.9^(1 - y[2, 5]) *
        (1 - expit(x[2, ] %*% beta[, 1])) * (1 - expit(x[2, ] %*% beta[, 2])) +
        0.8^y[2, 1] * 0.2^(1 - y[2, 1]) * 0.1^y[2, 2] * 0.9^(1 - y[2, 2]) *
        0.1^y[2, 3] * 0.9^(1 - y[2, 3]) * 0.8^y[2, 4] * 0.2^(1 - y[2, 4]) *
        0.8^y[2, 5] * 0.2^(1 - y[2, 5]) *
        (1 - expit(x[2, ] %*% beta[, 1])) * (expit(x[2, ] %*% beta[, 2])) +
        0.8^y[2, 1] * 0.2^(1 - y[2, 1]) * 0.8^y[2, 2] * 0.2^(1 - y[2, 2]) *
        0.8^y[2, 3] * 0.2^(1 - y[2, 3]) * 0.1^y[2, 4] * 0.9^(1 - y[2, 4]) *
        0.1^y[2, 5] * 0.9^(1 - y[2, 5]) *
        (expit(x[2, ] %*% beta[, 1])) * (1 - expit(x[2, ] %*% beta[, 2])) +
        0.8^y[2, 1] * 0.2^(1 - y[2, 1]) * 0.8^y[2, 2] * 0.2^(1 - y[2, 2]) *
        0.8^y[2, 3] * 0.2^(1 - y[2, 3]) * 0.8^y[2, 4] * 0.2^(1 - y[2, 4]) *
        0.8^y[2, 5] * 0.2^(1 - y[2, 5]) *
        (expit(x[2, ] %*% beta[, 1])) * (expit(x[2, ] %*% beta[, 2]))) +
    log(0.1^y[3, 1] * 0.9^(1 - y[3, 1]) * 0.1^y[3, 2] * 0.9^(1 - y[3, 2]) *
        0.1^y[3, 3] * 0.9^(1 - y[3, 3]) * 0.1^y[3, 4] * 0.9^(1 - y[3, 4]) *
        0.1^y[3, 5] * 0.9^(1 - y[3, 5]) *
        (1 - expit(x[3, ] %*% beta[, 1])) * (1 - expit(x[3, ] %*% beta[, 2])) +
        0.8^y[3, 1] * 0.2^(1 - y[3, 1]) * 0.1^y[3, 2] * 0.9^(1 - y[3, 2]) *
        0.1^y[3, 3] * 0.9^(1 - y[3, 3]) * 0.8^y[3, 4] * 0.2^(1 - y[3, 4]) *
        0.8^y[3, 5] * 0.2^(1 - y[3, 5]) *
        (1 - expit(x[3, ] %*% beta[, 1])) * (expit(x[3, ] %*% beta[, 2])) +
        0.8^y[3, 1] * 0.2^(1 - y[3, 1]) * 0.8^y[3, 2] * 0.2^(1 - y[3, 2]) *
        0.8^y[3, 3] * 0.2^(1 - y[3, 3]) * 0.1^y[3, 4] * 0.9^(1 - y[3, 4]) *
        0.1^y[3, 5] * 0.9^(1 - y[3, 5]) *
        (expit(x[3, ] %*% beta[, 1])) * (1 - expit(x[3, ] %*% beta[, 2])) +
        0.8^y[3, 1] * 0.2^(1 - y[3, 1]) * 0.8^y[3, 2] * 0.2^(1 - y[3, 2]) *
        0.8^y[3, 3] * 0.2^(1 - y[3, 3]) * 0.8^y[3, 4] * 0.2^(1 - y[3, 4]) *
        0.8^y[3, 5] * 0.2^(1 - y[3, 5]) *
        (expit(x[3, ] %*% beta[, 1])) * (expit(x[3, ] %*% beta[, 2]))) +
    log((0.1^y[4, 1] * 0.9^(1 - y[4, 1]) * 0.1^y[4, 2] * 0.9^(1 - y[4, 2]) *
          0.1^y[4, 3] * 0.9^(1 - y[4, 3]) * 0.1^y[4, 4] * 0.9^(1 - y[4, 4]) *
         0.1^y[4, 5] * 0.9^(1 - y[4, 5]) *
         (1 - expit(x[4, ] %*% beta[, 1])) * (1 - expit(x[4, ] %*% beta[, 2])) +
         0.8^y[4, 1] * 0.2^(1 - y[4, 1]) * 0.1^y[4, 2] * 0.9^(1 - y[4, 2]) *
         0.1^y[4, 3] * 0.9^(1 - y[4, 3]) * 0.8^y[4, 4] * 0.2^(1 - y[4, 4]) *
         0.8^y[4, 5] * 0.2^(1 - y[4, 5]) *
          (1 - expit(x[4, ] %*% beta[, 1])) * (expit(x[4, ] %*% beta[, 2])) +
         0.8^y[4, 1] * 0.2^(1 - y[4, 1]) * 0.8^y[4, 2] * 0.2^(1 - y[4, 2]) *
         0.8^y[4, 3] * 0.2^(1 - y[4, 3]) * 0.1^y[4, 4] * 0.9^(1 - y[4, 4]) *
         0.1^y[4, 5] * 0.9^(1 - y[4, 5]) *
         (expit(x[4, ] %*% beta[, 1])) * (1 - expit(x[4, ] %*% beta[, 2])) +
         0.8^y[4, 1] * 0.2^(1 - y[4, 1]) * 0.8^y[4, 2] * 0.2^(1 - y[4, 2]) *
         0.8^y[4, 3] * 0.2^(1 - y[4, 3]) * 0.8^y[4, 4] * 0.2^(1 - y[4, 4]) *
         0.8^y[4, 5] * 0.2^(1 - y[4, 5]) *
         (expit(x[4, ] %*% beta[, 1])) * (expit(x[4, ] %*% beta[, 2])))))
  expect_equal(round(res, 1), round(as.numeric(sum_res), 1))
})
